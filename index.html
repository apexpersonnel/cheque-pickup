<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0f172a">
<title>Cheque Pickup ‚Äî Apex Personnel</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@500;700&display=swap" rel="stylesheet">
<style>
/* ========================================
   DESIGN: Industrial-Refined Operations Tool
   PALETTE: Deep slate + warm amber accent
   FONT: Outfit (geometric, friendly) + JetBrains Mono (data)
   ======================================== */

:root {
  --bg: #f8fafc;
  --bg-warm: #faf8f5;
  --surface: #ffffff;
  --surface-raised: #ffffff;
  --text: #0f172a;
  --text-secondary: #64748b;
  --text-tertiary: #94a3b8;
  --accent: #f59e0b;
  --accent-hover: #d97706;
  --accent-soft: #fef3c7;
  --accent-glow: rgba(245, 158, 11, 0.15);
  --slate: #0f172a;
  --slate-soft: #1e293b;
  --green: #10b981;
  --green-soft: #d1fae5;
  --green-text: #065f46;
  --blue: #3b82f6;
  --blue-soft: #dbeafe;
  --red: #ef4444;
  --red-soft: #fee2e2;
  --border: #e2e8f0;
  --border-light: #f1f5f9;
  --shadow-sm: 0 1px 2px rgba(15,23,42,.04);
  --shadow-md: 0 4px 12px rgba(15,23,42,.06);
  --shadow-lg: 0 12px 40px rgba(15,23,42,.1);
  --shadow-glow: 0 0 0 3px var(--accent-glow);
  --radius: 12px;
  --radius-lg: 16px;
  --radius-xl: 20px;
  --transition: .2s cubic-bezier(.4,0,.2,1);
  --font: 'Outfit', -apple-system, sans-serif;
  --mono: 'JetBrains Mono', monospace;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html { -webkit-text-size-adjust: 100%; }
body {
  font-family: var(--font);
  background: var(--bg);
  color: var(--text);
  min-height: 100dvh;
  overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}
.hidden { display: none !important; }

/* ========== GLOBAL ANIMATIONS ========== */
@keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes slideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
@keyframes shake { 0%,100% { transform: translateX(0); } 20%,60% { transform: translateX(-8px); } 40%,80% { transform: translateX(8px); } }
@keyframes spin { to { transform: rotate(360deg); } }
@keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: .5; } }
@keyframes successPop { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.05); } 100% { transform: scale(1); opacity: 1; } }

/* ========== OFFLINE BAR ========== */
.offline-bar {
  position: fixed; top: 0; left: 0; right: 0; z-index: 1000;
  background: linear-gradient(135deg, #f59e0b, #d97706);
  color: #fff; text-align: center; padding: 8px 16px;
  font-size: 13px; font-weight: 600; letter-spacing: .2px;
  transform: translateY(-100%); transition: transform .3s cubic-bezier(.4,0,.2,1);
  box-shadow: 0 4px 12px rgba(245,158,11,.3);
}
.offline-bar.show { transform: translateY(0); }
.sync-badge {
  display: inline-block; background: rgba(255,255,255,.25);
  padding: 2px 10px; border-radius: 20px; font-size: 11px;
  margin-left: 8px; backdrop-filter: blur(4px);
}

/* ========== PIN SCREEN ========== */
.pin-screen {
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  min-height: 100dvh; padding: 24px;
  background: var(--slate);
  background-image: 
    radial-gradient(ellipse at 20% 80%, rgba(245,158,11,.08) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 20%, rgba(59,130,246,.06) 0%, transparent 50%);
  position: relative; overflow: hidden;
}
.pin-screen::before {
  content: ''; position: absolute; inset: 0;
  background: url("data:image/svg+xml,%3Csvg width='60' height='60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0v60M0 30h60' stroke='%23ffffff' stroke-opacity='.03' stroke-width='.5'/%3E%3C/svg%3E");
  pointer-events: none;
}
.pin-box {
  background: rgba(255,255,255,.05);
  border: 1px solid rgba(255,255,255,.08);
  backdrop-filter: blur(20px);
  border-radius: var(--radius-xl); padding: 48px 36px;
  text-align: center; max-width: 380px; width: 100%;
  animation: fadeUp .6s cubic-bezier(.4,0,.2,1);
  position: relative;
}
.pin-logo {
  width: 72px; height: 72px;
  background: linear-gradient(135deg, var(--accent), var(--accent-hover));
  border-radius: 18px; display: flex; align-items: center; justify-content: center;
  color: #fff; font-weight: 800; font-size: 26px; letter-spacing: -1px;
  margin: 0 auto 20px;
  box-shadow: 0 8px 32px rgba(245,158,11,.3);
}
.pin-box h2 { font-size: 24px; font-weight: 700; color: #fff; letter-spacing: -.5px; }
.pin-box .sub {
  font-size: 12px; color: rgba(255,255,255,.4); font-weight: 600;
  letter-spacing: 2px; margin: 4px 0 32px; text-transform: uppercase;
}
.pin-input { display: flex; gap: 12px; justify-content: center; margin-bottom: 24px; }
.pin-digit {
  width: 56px; height: 64px;
  border: 2px solid rgba(255,255,255,.1);
  border-radius: var(--radius); text-align: center;
  font-size: 26px; font-weight: 700; font-family: var(--mono);
  background: rgba(255,255,255,.05); color: #fff;
  outline: none; transition: var(--transition);
  -webkit-text-security: disc;
}
.pin-digit:focus { border-color: var(--accent); box-shadow: var(--shadow-glow); }
.pin-digit.filled { border-color: rgba(255,255,255,.2); background: rgba(255,255,255,.08); }
.pin-digit.error { border-color: var(--red); animation: shake .5s; }
.pin-error {
  color: #fca5a5; font-size: 13px; font-weight: 500;
  min-height: 20px; margin-bottom: 16px;
}
.pin-btn {
  width: 100%; padding: 16px;
  background: linear-gradient(135deg, var(--accent), var(--accent-hover));
  color: #fff; border: none; border-radius: var(--radius);
  font-size: 15px; font-weight: 700; font-family: var(--font);
  cursor: pointer; transition: var(--transition);
  letter-spacing: .3px;
  box-shadow: 0 4px 16px rgba(245,158,11,.3);
}
.pin-btn:not(:disabled):active { transform: scale(.98); }
.pin-btn:disabled { opacity: .3; box-shadow: none; }

/* ========== HEADER ========== */
.header {
  background: var(--slate);
  padding: 14px 16px; display: flex;
  align-items: center; justify-content: space-between;
  position: sticky; top: 0; z-index: 100;
  box-shadow: 0 1px 0 rgba(255,255,255,.05);
}
.header-left { display: flex; align-items: center; gap: 12px; }
.logo-sm {
  width: 36px; height: 36px;
  background: linear-gradient(135deg, var(--accent), var(--accent-hover));
  border-radius: 10px; display: flex; align-items: center; justify-content: center;
  color: #fff; font-weight: 800; font-size: 15px; letter-spacing: -0.5px;
}
.header h1 { font-size: 16px; font-weight: 700; color: #fff; letter-spacing: -.3px; }
.header .sub { font-size: 9px; color: rgba(255,255,255,.35); font-weight: 600; letter-spacing: 1.5px; text-transform: uppercase; }
.header-actions { display: flex; gap: 6px; align-items: center; }
.btn-icon {
  width: 38px; height: 38px; border-radius: 10px;
  border: 1px solid rgba(255,255,255,.1);
  background: rgba(255,255,255,.05);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 16px; transition: var(--transition);
  color: #fff;
}
.btn-icon:active { background: rgba(255,255,255,.12); transform: scale(.95); }

/* ========== FILTER / SEARCH BAR ========== */
.filter-bar {
  padding: 12px 16px;
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  display: flex; gap: 8px; flex-wrap: wrap; align-items: center;
  animation: slideDown .4s cubic-bezier(.4,0,.2,1);
}
.filter-select {
  padding: 10px 12px; border: 1px solid var(--border);
  border-radius: 10px; font-size: 13px; font-weight: 500;
  font-family: var(--font); background: var(--bg);
  color: var(--text); min-width: 0; flex-shrink: 0;
  transition: var(--transition); cursor: pointer;
  appearance: none; -webkit-appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%2394a3b8' fill='none' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  padding-right: 28px;
}
.filter-select:focus { outline: none; border-color: var(--accent); box-shadow: var(--shadow-glow); }
.search-wrap { flex: 1; min-width: 180px; position: relative; }
.search-wrap input {
  width: 100%; padding: 10px 14px 10px 40px;
  border: 1px solid var(--border); border-radius: 10px;
  font-size: 14px; font-weight: 400; font-family: var(--font);
  background: var(--bg); outline: none; transition: var(--transition);
  color: var(--text);
}
.search-wrap input::placeholder { color: var(--text-tertiary); }
.search-wrap input:focus { border-color: var(--accent); box-shadow: var(--shadow-glow); background: var(--surface); }
.search-icon {
  position: absolute; left: 13px; top: 50%; transform: translateY(-50%);
  width: 18px; height: 18px; color: var(--text-tertiary); pointer-events: none;
}
.search-loading {
  position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
  width: 18px; height: 18px;
  border: 2px solid var(--border); border-top-color: var(--accent);
  border-radius: 50%; animation: spin .6s linear infinite;
  display: none;
}
.search-loading.show { display: block; }

/* ========== RESULTS ========== */
.results-section { padding: 8px 16px 0; }
.result-header {
  display: flex; justify-content: space-between; align-items: center;
  padding: 8px 0;
}
.result-count { font-size: 13px; color: var(--text-secondary); font-weight: 500; }
.btn-select-all {
  font-size: 12px; font-weight: 600; color: var(--accent-hover);
  background: var(--accent-soft); border: none; cursor: pointer;
  padding: 5px 12px; border-radius: 6px; transition: var(--transition);
  font-family: var(--font);
}
.btn-select-all:active { transform: scale(.96); }

.cheque-list { display: flex; flex-direction: column; gap: 6px; }

.cheque-row {
  display: flex; align-items: center; gap: 10px;
  padding: 12px 14px; background: var(--surface);
  border: 1.5px solid var(--border-light);
  border-radius: var(--radius); cursor: pointer;
  transition: all .15s cubic-bezier(.4,0,.2,1);
  flex-wrap: wrap; position: relative;
  box-shadow: var(--shadow-sm);
}
.cheque-row:active { transform: scale(.99); }
.cheque-row.selected {
  border-color: var(--accent);
  background: linear-gradient(135deg, var(--accent-soft), #fff);
  box-shadow: var(--shadow-glow), var(--shadow-sm);
}
.cheque-row.signed {
  opacity: .55; cursor: default;
  background: var(--bg-warm);
  box-shadow: none; border-color: transparent;
}
.cheque-row.signed:active { transform: none; }

.cb {
  width: 22px; height: 22px;
  border: 2px solid var(--border);
  border-radius: 7px; display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; transition: var(--transition);
}
.cb svg { display: none; width: 14px; height: 14px; }
.cheque-row.selected .cb {
  border-color: var(--accent); background: var(--accent);
}
.cheque-row.selected .cb svg { display: block; color: #fff; }

.chq-info { flex: 1; min-width: 0; }
.chq-top { display: flex; align-items: center; gap: 8px; margin-bottom: 2px; }
.chq-num {
  font-family: var(--mono); font-weight: 700; font-size: 13px;
  color: var(--accent-hover); letter-spacing: -.3px;
}
.chq-name { font-weight: 600; font-size: 15px; letter-spacing: -.2px; }
.chq-bottom { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
.chq-client { color: var(--text-tertiary); font-size: 12px; font-weight: 400; }
.chq-pay {
  font-family: var(--mono); font-size: 14px; font-weight: 700;
  color: var(--green-text); white-space: nowrap; margin-left: auto;
  background: var(--green-soft); padding: 3px 10px; border-radius: 6px;
}
.tag {
  font-size: 10px; font-weight: 700; padding: 3px 8px;
  border-radius: 5px; white-space: nowrap; letter-spacing: .3px;
  text-transform: uppercase;
}
.tag-week { color: var(--accent-hover); background: var(--accent-soft); }
.tag-office { color: var(--blue); background: var(--blue-soft); }

.signed-badge {
  font-size: 12px; color: var(--green-text); font-weight: 500;
  width: 100%; display: flex; align-items: center; gap: 4px;
  padding: 4px 0 0 32px;
}
.signed-badge svg { width: 14px; height: 14px; color: var(--green); }

.empty-state {
  text-align: center; padding: 40px 20px;
  color: var(--text-tertiary); font-size: 14px; font-weight: 400;
}
.empty-state .empty-icon { font-size: 40px; margin-bottom: 12px; opacity: .5; }

/* ========== SELECTED BAR ========== */
.selected-bar {
  background: var(--surface); border: 1.5px solid var(--accent);
  border-radius: var(--radius); margin: 12px 16px 0;
  padding: 14px; box-shadow: var(--shadow-glow);
  animation: fadeUp .3s cubic-bezier(.4,0,.2,1);
}
.selected-title {
  font-size: 14px; font-weight: 600; margin-bottom: 10px;
  display: flex; align-items: center; gap: 6px;
}
.selected-title .count-badge {
  background: var(--accent); color: #fff;
  font-size: 11px; font-weight: 700;
  padding: 2px 8px; border-radius: 10px;
}
.selected-chips { display: flex; flex-wrap: wrap; gap: 6px; }
.selected-chip {
  display: flex; align-items: center; gap: 6px;
  background: var(--bg); border: 1px solid var(--border);
  border-radius: 8px; padding: 6px 10px; font-size: 12px; font-weight: 500;
  animation: successPop .3s cubic-bezier(.4,0,.2,1);
}
.chip-chq { font-family: var(--mono); font-weight: 700; color: var(--accent-hover); }
.chip-pay { font-family: var(--mono); font-weight: 600; color: var(--green-text); font-size: 10px; }
.chip-remove {
  cursor: pointer; color: var(--text-tertiary); font-weight: 700;
  padding: 0 2px; transition: var(--transition);
  width: 18px; height: 18px; display: flex; align-items: center; justify-content: center;
  border-radius: 50%;
}
.chip-remove:hover { background: var(--red-soft); color: var(--red); }

/* ========== ACTION AREA ========== */
.action-area { padding: 12px 16px 24px; }
.action-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: var(--radius-lg); padding: 20px;
  box-shadow: var(--shadow-md);
  animation: fadeUp .4s cubic-bezier(.4,0,.2,1);
}
.action-card h3 {
  font-size: 16px; font-weight: 700; margin-bottom: 16px;
  display: flex; align-items: center; gap: 8px;
}
.action-card h3 .step-dot {
  width: 24px; height: 24px; border-radius: 50%;
  background: var(--accent-soft); color: var(--accent-hover);
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 800;
}
.input-row { margin-bottom: 16px; }
.input-row label {
  font-size: 12px; font-weight: 600; color: var(--text-secondary);
  display: block; margin-bottom: 6px; letter-spacing: .3px;
}
.input-row input {
  width: 100%; padding: 12px 14px;
  border: 1.5px solid var(--border); border-radius: 10px;
  font-size: 15px; font-family: var(--font); font-weight: 400;
  background: var(--bg); transition: var(--transition);
  color: var(--text);
}
.input-row input:focus { outline: none; border-color: var(--accent); box-shadow: var(--shadow-glow); background: var(--surface); }
.input-row input::placeholder { color: var(--text-tertiary); }

.photo-area { display: flex; gap: 10px; margin-bottom: 16px; }
.btn-camera, .btn-upload {
  flex: 1; padding: 16px 12px;
  border: 1.5px dashed var(--border);
  border-radius: var(--radius); background: var(--bg);
  cursor: pointer; text-align: center;
  font-size: 13px; font-weight: 600; font-family: var(--font);
  transition: var(--transition); color: var(--text-secondary);
  display: flex; flex-direction: column; align-items: center; gap: 6px;
}
.btn-camera .cam-icon, .btn-upload .cam-icon { font-size: 24px; }
.btn-camera:active, .btn-upload:active {
  border-color: var(--accent); background: var(--accent-soft);
  transform: scale(.97);
}
.photo-preview { margin-bottom: 16px; display: none; position: relative; border-radius: var(--radius); overflow: hidden; }
.photo-preview img { width: 100%; display: block; max-height: 200px; object-fit: cover; }
.photo-preview .retake-btn {
  position: absolute; top: 8px; right: 8px;
  background: rgba(0,0,0,.6); color: #fff;
  border: none; border-radius: 8px; padding: 6px 12px;
  font-size: 11px; font-weight: 600; font-family: var(--font);
  cursor: pointer; backdrop-filter: blur(4px);
}

.btn-confirm {
  width: 100%; padding: 16px;
  background: linear-gradient(135deg, var(--accent), var(--accent-hover));
  color: #fff; border: none; border-radius: var(--radius);
  font-size: 16px; font-weight: 700; font-family: var(--font);
  cursor: pointer; transition: var(--transition);
  letter-spacing: .3px;
  box-shadow: 0 4px 16px rgba(245,158,11,.25);
}
.btn-confirm:not(:disabled):active { transform: scale(.98); }
.btn-confirm:disabled { opacity: .35; box-shadow: none; cursor: default; }
.btn-confirm.processing {
  background: var(--text-secondary);
  animation: pulse 1.2s infinite;
  box-shadow: none;
}
.hint { font-size: 11px; color: var(--text-tertiary); text-align: center; margin-top: 10px; }

/* ========== HISTORY ========== */
.history-section { padding: 16px; }
.history-section h3 {
  font-size: 14px; margin-bottom: 10px; font-weight: 600;
  color: var(--text-secondary); display: flex; align-items: center; gap: 6px;
}
.history-item {
  background: var(--surface); border: 1px solid var(--border-light);
  border-radius: var(--radius); padding: 12px 14px; margin-bottom: 6px;
  font-size: 13px; box-shadow: var(--shadow-sm);
  animation: fadeUp .3s cubic-bezier(.4,0,.2,1);
}
.hi-top { display: flex; justify-content: space-between; margin-bottom: 4px; }
.hi-collector { font-weight: 600; }
.hi-time { color: var(--text-tertiary); font-size: 12px; }
.hi-cheques { color: var(--text-secondary); font-size: 12px; }
.hi-cheques span { color: var(--accent-hover); font-family: var(--mono); font-weight: 600; }
.hi-offline { color: var(--accent-hover); font-size: 11px; font-weight: 600; margin-top: 4px; }

/* ========== ADMIN MODAL ========== */
.modal-overlay {
  position: fixed; inset: 0; background: rgba(15,23,42,.6);
  z-index: 200; display: flex; align-items: center; justify-content: center;
  padding: 16px; backdrop-filter: blur(4px);
  animation: fadeIn .2s;
}
.modal {
  background: var(--surface); border-radius: var(--radius-xl);
  max-width: 440px; width: 100%; padding: 28px;
  max-height: 85vh; overflow-y: auto;
  box-shadow: var(--shadow-lg);
  animation: fadeUp .3s cubic-bezier(.4,0,.2,1);
}
.modal h3 { font-size: 20px; font-weight: 700; letter-spacing: -.3px; }
.modal .sub { font-size: 13px; color: var(--text-secondary); margin: 4px 0 20px; }
.upload-zone {
  border: 2px dashed var(--border); border-radius: var(--radius);
  padding: 40px 16px; text-align: center; cursor: pointer;
  margin-bottom: 16px; transition: var(--transition);
}
.upload-zone:active { border-color: var(--accent); background: var(--accent-soft); }
.upload-zone .icon { font-size: 36px; margin-bottom: 10px; }
.upload-zone .text { font-size: 14px; font-weight: 600; color: var(--text-secondary); }
.upload-preview { margin-bottom: 16px; }
.upload-preview .up-week {
  font-size: 18px; font-weight: 700; color: var(--accent-hover); margin-bottom: 4px;
}
.upload-preview .up-offices { font-size: 13px; color: var(--text-secondary); }
.upload-preview .up-count { font-size: 13px; margin-top: 4px; }
.btn-modal {
  padding: 12px 24px; border: none; border-radius: 10px;
  font-size: 14px; font-weight: 600; cursor: pointer;
  font-family: var(--font); transition: var(--transition);
}
.btn-modal:active { transform: scale(.97); }
.btn-modal-primary {
  background: linear-gradient(135deg, var(--accent), var(--accent-hover));
  color: #fff; box-shadow: 0 4px 12px rgba(245,158,11,.25);
}
.btn-modal-secondary { background: var(--bg); color: var(--text); }
.btn-modal:disabled { opacity: .4; }
.modal-actions { display: flex; justify-content: flex-end; gap: 8px; }
.upload-progress { margin-bottom: 12px; font-size: 13px; color: var(--text-secondary); animation: pulse 1.5s infinite; }
.upload-error { color: var(--red); font-size: 13px; margin-bottom: 12px; }
.upload-success { color: var(--green); font-size: 13px; margin-bottom: 12px; font-weight: 600; }

/* ========== WEBCAM MODAL ========== */
.webcam-video-wrap {
  margin: 16px 0; border-radius: var(--radius); overflow: hidden;
  background: #000; position: relative; box-shadow: var(--shadow-md);
}
.webcam-video-wrap video { width: 100%; display: block; max-height: 50vh; }

/* ========== TOAST ========== */
.toast {
  position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%) translateY(20px);
  background: var(--slate); color: #fff;
  padding: 12px 24px; border-radius: 14px;
  font-size: 14px; font-weight: 600; z-index: 300;
  opacity: 0; transition: all .3s cubic-bezier(.4,0,.2,1);
  pointer-events: none; box-shadow: var(--shadow-lg);
  max-width: calc(100vw - 32px);
}
.toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

/* ========== MOBILE OPTIMIZATIONS ========== */
@media (max-width: 480px) {
  .pin-box { padding: 36px 24px; }
  .pin-digit { width: 52px; height: 58px; font-size: 22px; }
  .filter-bar { padding: 10px 12px; gap: 6px; }
  .filter-select { padding: 8px 10px; font-size: 12px; }
  .search-wrap input { padding: 8px 12px 8px 36px; font-size: 13px; }
  .cheque-row { padding: 10px 12px; }
  .chq-name { font-size: 14px; }
  .action-card { padding: 16px; }
  .results-section { padding: 8px 12px 0; }
  .selected-bar { margin: 10px 12px 0; }
  .action-area { padding: 10px 12px 20px; }
  .history-section { padding: 12px; }
}

/* ========== SAFE AREA (notch devices) ========== */
@supports (padding-top: env(safe-area-inset-top)) {
  .header { padding-top: max(14px, env(safe-area-inset-top)); }
  .toast { bottom: max(32px, calc(env(safe-area-inset-bottom) + 12px)); }
}

/* ========== DARK MODE ========== */
.dark {
  --bg: #0c1017;
  --bg-warm: #0f1520;
  --surface: #161d2b;
  --surface-raised: #1c2536;
  --text: #e8ecf2;
  --text-secondary: #8494a7;
  --text-tertiary: #556479;
  --accent: #f59e0b;
  --accent-hover: #fbbf24;
  --accent-soft: rgba(245,158,11,.12);
  --accent-glow: rgba(245,158,11,.12);
  --slate: #0a0f18;
  --slate-soft: #111827;
  --green: #34d399;
  --green-soft: rgba(16,185,129,.1);
  --green-text: #6ee7b7;
  --blue: #60a5fa;
  --blue-soft: rgba(59,130,246,.12);
  --red: #f87171;
  --red-soft: rgba(239,68,68,.12);
  --border: #1e293b;
  --border-light: #1a2332;
  --shadow-sm: 0 1px 2px rgba(0,0,0,.2);
  --shadow-md: 0 4px 12px rgba(0,0,0,.25);
  --shadow-lg: 0 12px 40px rgba(0,0,0,.4);
}
.dark .pin-screen { background: var(--slate); }
.dark .pin-screen::before { opacity: .5; }
.dark .pin-box {
  background: rgba(255,255,255,.03);
  border-color: rgba(255,255,255,.06);
}
.dark .pin-digit {
  background: rgba(255,255,255,.04);
  border-color: rgba(255,255,255,.08);
}
.dark .pin-digit:focus { border-color: var(--accent); }
.dark .pin-digit.filled { background: rgba(255,255,255,.07); border-color: rgba(255,255,255,.15); }
.dark .filter-select {
  background: var(--surface);
  border-color: var(--border);
  color: var(--text);
  background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1l4 4 4-4' stroke='%23556479' fill='none' stroke-width='1.5' stroke-linecap='round'/%3E%3C/svg%3E");
}
.dark .search-wrap input { background: var(--surface); border-color: var(--border); color: var(--text); }
.dark .search-wrap input:focus { background: var(--surface-raised); }
.dark .cheque-row { background: var(--surface); border-color: var(--border); }
.dark .cheque-row.selected { background: rgba(245,158,11,.06); border-color: var(--accent); }
.dark .cheque-row.signed { background: var(--bg-warm); border-color: transparent; }
.dark .input-row input { background: var(--bg); border-color: var(--border); color: var(--text); }
.dark .input-row input:focus { background: var(--surface); }
.dark .btn-camera, .dark .btn-upload { background: var(--bg); border-color: var(--border); color: var(--text-secondary); }
.dark .modal { background: var(--surface); }
.dark .modal-overlay { background: rgba(0,0,0,.7); }
.dark .upload-zone { border-color: var(--border); }
.dark .btn-modal-secondary { background: var(--bg); color: var(--text); }
.dark .selected-chip { background: var(--bg); border-color: var(--border); }
.dark .action-card { background: var(--surface); border-color: var(--border); }
.dark .history-item { background: var(--surface); border-color: var(--border); }
.dark .toast { background: var(--surface-raised); }
.dark .chq-pay { background: var(--green-soft); color: var(--green-text); }

/* ========== THEME TOGGLE ========== */
.theme-toggle {
  width: 38px; height: 38px; border-radius: 10px;
  border: 1px solid rgba(255,255,255,.1);
  background: rgba(255,255,255,.05);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 16px; transition: var(--transition);
  color: #fff; position: relative; overflow: hidden;
}
.theme-toggle:active { background: rgba(255,255,255,.12); transform: scale(.95); }
.theme-toggle .icon-sun, .theme-toggle .icon-moon { transition: var(--transition); position: absolute; }
.theme-toggle .icon-sun { opacity: 0; transform: rotate(-90deg) scale(.5); }
.theme-toggle .icon-moon { opacity: 1; transform: rotate(0) scale(1); }
.dark .theme-toggle .icon-sun { opacity: 1; transform: rotate(0) scale(1); }
.dark .theme-toggle .icon-moon { opacity: 0; transform: rotate(90deg) scale(.5); }
</style>
</head>
<body>

<!-- OFFLINE BAR -->
<div class="offline-bar" id="offlineBar">
  ‚ö° You're offline ‚Äî pickups will sync when connection returns
  <span class="sync-badge" id="syncBadge">0 queued</span>
</div>

<!-- PIN SCREEN -->
<div id="pinScreen" class="pin-screen">
  <button class="theme-toggle" id="pinThemeToggle" title="Toggle dark mode" style="position:absolute;top:16px;right:16px;border-color:rgba(255,255,255,.15)">
    <svg class="icon-sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
    <svg class="icon-moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
  </button>
  <div class="pin-box">
    <div class="pin-logo">AP</div>
    <h2>Cheque Pickup</h2>
    <div class="sub">Apex Personnel Inc.</div>
    <div class="pin-input">
      <input class="pin-digit" type="tel" maxlength="1" inputmode="numeric" autofocus>
      <input class="pin-digit" type="tel" maxlength="1" inputmode="numeric">
      <input class="pin-digit" type="tel" maxlength="1" inputmode="numeric">
      <input class="pin-digit" type="tel" maxlength="1" inputmode="numeric">
    </div>
    <div class="pin-error" id="pinError"></div>
    <button class="pin-btn" id="pinBtn" disabled>Unlock</button>
  </div>
</div>

<!-- MAIN SCREEN -->
<div id="mainScreen" class="hidden">
  <div class="header">
    <div class="header-left">
      <div class="logo-sm">AP</div>
      <div><h1>Cheque Pickup</h1><div class="sub">Apex Personnel Inc.</div></div>
    </div>
    <div class="header-actions">
      <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">
        <svg class="icon-sun" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        <svg class="icon-moon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg>
      </button>
      <button class="btn-icon" id="adminBtn" title="Upload Payroll">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
      </button>
    </div>
  </div>

  <div class="filter-bar">
    <select class="filter-select" id="weekFilter"><option value="ALL">All Weeks</option></select>
    <select class="filter-select" id="officeFilter"><option value="ALL">All Offices</option></select>
    <div class="search-wrap">
      <svg class="search-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
      <input type="text" id="searchInput" placeholder="Search name, client, or cheque #..." autocomplete="off">
      <div class="search-loading" id="searchLoading"></div>
    </div>
  </div>

  <div class="results-section hidden" id="resultsSection">
    <div class="result-header">
      <span class="result-count" id="resultCount"></span>
      <button class="btn-select-all hidden" id="selectAllBtn">Select All</button>
    </div>
    <div class="cheque-list" id="chequeList"></div>
  </div>

  <div class="selected-bar hidden" id="selectedBar">
    <div class="selected-title" id="selectedTitle"></div>
    <div class="selected-chips" id="selectedChips"></div>
  </div>

  <div class="action-area hidden" id="actionArea">
    <div class="action-card">
      <h3><span class="step-dot">‚úì</span> Confirm Pickup</h3>
      <div class="input-row">
        <label>Collector's Name</label>
        <input type="text" id="collectorInput" placeholder="Who is collecting?">
      </div>
      <div class="photo-area">
        <button class="btn-camera" id="cameraBtn">
          <span class="cam-icon">üì∑</span>
          <span>Camera</span>
        </button>
        <button class="btn-upload" id="uploadBtn">
          <span class="cam-icon">üìÅ</span>
          <span>Upload</span>
        </button>
      </div>
      <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden">
      <input type="file" id="uploadInput" accept="image/*" class="hidden">
      <div class="photo-preview" id="photoPreview">
        <img id="photoImg">
        <button class="retake-btn" id="retakeBtn">‚úï Retake</button>
      </div>
      <button class="btn-confirm" id="confirmBtn" disabled>Confirm Pickup</button>
      <div class="hint">Updates Google Sheets & saves photo to Drive</div>
    </div>
  </div>

  <div class="history-section hidden" id="historySection">
    <h3>
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      This Session
    </h3>
    <div id="historyList"></div>
  </div>
</div>

<!-- ADMIN UPLOAD MODAL -->
<div class="modal-overlay hidden" id="adminModal">
  <div class="modal">
    <h3>Upload Payroll</h3>
    <div class="sub">Select a payroll Excel file to import</div>
    <div class="upload-zone" id="uploadZone">
      <div class="icon">üìÑ</div>
      <div class="text">Tap to select .xlsx file</div>
    </div>
    <input type="file" id="payrollFileInput" accept=".xlsx,.xls" class="hidden">
    <div class="upload-preview hidden" id="uploadPreview">
      <div class="up-week" id="upWeek"></div>
      <div class="up-offices" id="upOffices"></div>
      <div class="up-count" id="upCount"></div>
    </div>
    <div class="upload-progress hidden" id="uploadProgress">Uploading...</div>
    <div class="upload-error hidden" id="uploadError"></div>
    <div class="upload-success hidden" id="uploadSuccess"></div>
    <div class="modal-actions">
      <button class="btn-modal btn-modal-secondary" id="modalCloseBtn">Cancel</button>
      <button class="btn-modal btn-modal-primary hidden" id="modalUploadBtn" disabled>Upload</button>
    </div>
  </div>
</div>

<!-- WEBCAM MODAL -->
<div class="modal-overlay hidden" id="webcamModal">
  <div class="modal" style="max-width:500px">
    <h3>üì∑ Take Photo</h3>
    <div class="webcam-video-wrap">
      <video id="webcamVideo" autoplay playsinline></video>
    </div>
    <div id="webcamError" class="upload-error hidden"></div>
    <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
      <button class="btn-modal btn-modal-secondary" id="webcamCloseBtn">Cancel</button>
      <button class="btn-modal btn-modal-primary" id="webcamSnapBtn">üì∏ Capture</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<!-- CANVAS FOR PHOTO STAMPING (hidden) -->
<canvas id="stampCanvas" class="hidden"></canvas>

<script>
// =============================================
// CONFIGURATION
// =============================================
const API_URL = 'https://script.google.com/macros/s/AKfycby1YGRjS5Qhb5wgZmPS0T036uMWkXM-KuW-tIZBG4JmN4vbQqIc2X1EdJ10TLzzQNaaQg/exec';

// =============================================
// STATE
// =============================================
let pin = '';
let weeksData = {};
let searchResults = [];
let selected = new Set();
let photoDataUrl = null;
let history = [];
let offlineQueue = [];
let isOnline = navigator.onLine;
let searchTimeout = null;
let currentSearchId = 0;

// =============================================
// THEME (auto-detect + manual toggle)
// =============================================
(function initTheme() {
  const saved = localStorage.getItem('cheque_theme');
  if (saved === 'dark') {
    document.documentElement.classList.add('dark');
  } else if (saved === 'light') {
    document.documentElement.classList.remove('dark');
  } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
    document.documentElement.classList.add('dark');
  }
})();

// Listen for system theme changes (only if no manual override)
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
  if (!localStorage.getItem('cheque_theme')) {
    document.documentElement.classList.toggle('dark', e.matches);
  }
});

// =============================================
// ELEMENTS
// =============================================
const $ = id => document.getElementById(id);
const pinScreen = $('pinScreen');
const mainScreen = $('mainScreen');
const pinDigits = document.querySelectorAll('.pin-digit');
const pinError = $('pinError');
const pinBtn = $('pinBtn');
const offlineBar = $('offlineBar');
const syncBadge = $('syncBadge');
const weekFilter = $('weekFilter');
const officeFilter = $('officeFilter');
const searchInput = $('searchInput');
const searchLoading = $('searchLoading');
const resultsSection = $('resultsSection');
const resultCount = $('resultCount');
const selectAllBtn = $('selectAllBtn');
const chequeList = $('chequeList');
const selectedBar = $('selectedBar');
const selectedTitle = $('selectedTitle');
const selectedChips = $('selectedChips');
const actionArea = $('actionArea');
const collectorInput = $('collectorInput');
const confirmBtn = $('confirmBtn');
const photoPreview = $('photoPreview');
const photoImg = $('photoImg');
const historySection = $('historySection');
const historyList = $('historyList');
const toast = $('toast');

// =============================================
// OFFLINE DETECTION
// =============================================
window.addEventListener('online', () => { isOnline = true; updateOfflineBar(); syncOfflineQueue(); });
window.addEventListener('offline', () => { isOnline = false; updateOfflineBar(); });

function updateOfflineBar() {
  offlineBar.classList.toggle('show', !isOnline || offlineQueue.length > 0);
  if (isOnline && offlineQueue.length > 0) {
    offlineBar.textContent = 'üîÑ Syncing ' + offlineQueue.length + ' queued pickup(s)...';
  } else if (!isOnline) {
    offlineBar.innerHTML = '‚ö° You\'re offline ‚Äî pickups will sync when connection returns <span class="sync-badge">' + offlineQueue.length + ' queued</span>';
  } else {
    offlineBar.classList.remove('show');
  }
}

// =============================================
// API CALLS
// =============================================

// Theme toggle buttons
function toggleTheme() {
  const isDark = document.documentElement.classList.toggle('dark');
  localStorage.setItem('cheque_theme', isDark ? 'dark' : 'light');
}
$('themeToggle').addEventListener('click', toggleTheme);
$('pinThemeToggle').addEventListener('click', toggleTheme);

async function api(payload) {
  if (!payload.pin) payload.pin = pin;
  try {
    const resp = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload),
      redirect: 'follow'
    });
    const text = await resp.text();
    try { return JSON.parse(text); }
    catch (e) {
      console.error('API response not JSON:', text.substring(0, 500));
      throw new Error('Invalid response from server');
    }
  } catch (err) {
    console.error('API call failed:', err);
    throw err;
  }
}

// =============================================
// PIN LOGIN
// =============================================
pinDigits.forEach((d, i) => {
  d.addEventListener('input', () => {
    d.value = d.value.replace(/\D/g, '');
    if (d.value) {
      d.classList.add('filled');
      if (i < 3) pinDigits[i + 1].focus();
    } else {
      d.classList.remove('filled');
    }
    updatePinBtn();
  });
  d.addEventListener('keydown', (e) => {
    if (e.key === 'Backspace' && !d.value && i > 0) {
      pinDigits[i - 1].focus();
      pinDigits[i - 1].value = '';
      pinDigits[i - 1].classList.remove('filled');
    }
    if (e.key === 'Enter') pinBtn.click();
  });
  d.addEventListener('focus', () => d.select());
});

function updatePinBtn() {
  const code = Array.from(pinDigits).map(d => d.value).join('');
  pinBtn.disabled = code.length !== 4;
}

pinBtn.addEventListener('click', async () => {
  const code = Array.from(pinDigits).map(d => d.value).join('');
  pinBtn.disabled = true;
  pinBtn.textContent = 'Verifying...';
  pinError.textContent = '';

  try {
    const res = await api({ action: 'verifyPin', pin: code });
    console.log('PIN response:', JSON.stringify(res));
    if (res.ok) {
      pin = code;
      localStorage.setItem('cheque_pin', code);
      pinScreen.classList.add('hidden');
      mainScreen.classList.remove('hidden');
      await loadWeeks();
      loadOfflineQueue();
      loadSessionHistory();
      if (offlineQueue.length > 0) syncOfflineQueue();
    } else {
      pinError.textContent = res.error || 'Incorrect PIN';
      pinDigits.forEach(d => { d.classList.add('error'); d.value = ''; d.classList.remove('filled'); });
      pinDigits[0].focus();
      setTimeout(() => pinDigits.forEach(d => d.classList.remove('error')), 600);
    }
  } catch (err) {
    console.error('PIN verify error:', err);
    pinError.textContent = 'Connection error: ' + err.message;
  }
  pinBtn.disabled = false;
  pinBtn.textContent = 'Unlock';
});

// Auto-login if PIN cached
(function() {
  const cached = localStorage.getItem('cheque_pin');
  if (cached) {
    const digits = cached.split('');
    pinDigits.forEach((d, i) => { d.value = digits[i] || ''; if (d.value) d.classList.add('filled'); });
    updatePinBtn();
  }
})();

// =============================================
// LOAD WEEKS & OFFICES
// =============================================
async function loadWeeks() {
  try {
    const res = await api({ action: 'getWeeks' });
    weeksData = res.weeks || {};
    weekFilter.innerHTML = '<option value="ALL">All Weeks</option>';
    Object.keys(weeksData).forEach(w => {
      weekFilter.innerHTML += '<option value="' + w + '">' + w + '</option>';
    });
    updateOfficeFilter();
  } catch (err) {
    showToast('Could not load weeks ‚Äî check connection');
  }
}

function updateOfficeFilter() {
  const w = weekFilter.value;
  let offices = new Set();
  if (w === 'ALL') {
    Object.values(weeksData).forEach(arr => arr.forEach(o => offices.add(o)));
  } else if (weeksData[w]) {
    weeksData[w].forEach(o => offices.add(o));
  }
  officeFilter.innerHTML = '<option value="ALL">All Offices</option>';
  Array.from(offices).sort().forEach(o => {
    officeFilter.innerHTML += '<option value="' + o + '">' + o + '</option>';
  });
}

weekFilter.addEventListener('change', () => { updateOfficeFilter(); doSearch(); });
officeFilter.addEventListener('change', doSearch);

// =============================================
// SEARCH
// =============================================
searchInput.addEventListener('input', () => {
  clearTimeout(searchTimeout);
  const q = searchInput.value.trim();
  if (q.length < 2) {
    resultsSection.classList.add('hidden');
    searchResults = [];
    renderSelectedBar();
    return;
  }
  searchTimeout = setTimeout(doSearch, 350);
});

async function doSearch() {
  const q = searchInput.value.trim();
  if (q.length < 2) { resultsSection.classList.add('hidden'); return; }
  const thisSearchId = ++currentSearchId;
  searchLoading.classList.add('show');
  try {
    const res = await api({ action: 'search', query: q, week: weekFilter.value, office: officeFilter.value });
    if (thisSearchId !== currentSearchId) return;
    searchResults = res.results || [];
    renderResults();
  } catch (err) {
    if (thisSearchId !== currentSearchId) return;
    chequeList.innerHTML = '<div class="empty-state"><div class="empty-icon">‚ö†Ô∏è</div>Search failed ‚Äî check connection</div>';
    resultsSection.classList.remove('hidden');
  }
  searchLoading.classList.remove('show');
}

// =============================================
// RENDER RESULTS
// =============================================
function renderResults() {
  const q = searchInput.value.trim();
  if (!q) { resultsSection.classList.add('hidden'); return; }
  resultsSection.classList.remove('hidden');

  const uncollected = searchResults.filter(c => !c.hasSignature);
  const collected = searchResults.filter(c => c.hasSignature);

  let ct = uncollected.length + ' available';
  if (collected.length > 0) ct += ' ¬∑ ' + collected.length + ' collected';
  resultCount.textContent = ct;

  if (uncollected.length > 1) {
    selectAllBtn.classList.remove('hidden');
    selectAllBtn.textContent = uncollected.every(c => selected.has(c.uid)) ? 'Deselect All' : 'Select All';
  } else { selectAllBtn.classList.add('hidden'); }

  if (searchResults.length === 0) {
    chequeList.innerHTML = '<div class="empty-state"><div class="empty-icon">üîç</div>No cheques match "' + q + '"</div>';
    renderSelectedBar();
    return;
  }

  chequeList.innerHTML = '';
  const showWeek = weekFilter.value === 'ALL';
  const showOffice = officeFilter.value === 'ALL';

  const checkSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>';
  const signedSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>';

  searchResults.forEach(c => {
    const row = document.createElement('div');

    if (c.hasSignature) {
      row.className = 'cheque-row signed';
      let collectedBy = '', collectedAt = '';
      if (c.signatureText.indexOf('Collected by') === 0) {
        const parts = c.signatureText.split(' \u2014 ');
        if (parts[0]) collectedBy = parts[0].replace('Collected by ', '');
        if (parts[1]) collectedAt = parts[1];
      } else { collectedBy = c.signatureText; }

      row.innerHTML = '<div class="cb" style="border-color:transparent;background:transparent"></div>'
        + '<div class="chq-info">'
          + '<div class="chq-top">'
            + '<span class="chq-num" style="opacity:.5">' + c.chqNo + '</span>'
            + '<span class="chq-name" style="opacity:.6">' + c.lastName + ' ' + c.firstName + '</span>'
          + '</div>'
          + '<div class="chq-bottom">'
            + (showWeek ? '<span class="tag tag-week">' + c.week + '</span>' : '')
            + (showOffice ? '<span class="tag tag-office">' + c.office + '</span>' : '')
          + '</div>'
          + '<div class="signed-badge">' + signedSvg + ' ' + (collectedBy || 'Collected') + (collectedAt ? ' ¬∑ ' + collectedAt : '') + '</div>'
        + '</div>';
    } else {
      row.className = 'cheque-row' + (selected.has(c.uid) ? ' selected' : '');
      row.innerHTML = '<div class="cb">' + checkSvg + '</div>'
        + '<div class="chq-info">'
          + '<div class="chq-top">'
            + '<span class="chq-num">' + c.chqNo + '</span>'
            + '<span class="chq-name">' + c.lastName + ' ' + c.firstName + '</span>'
          + '</div>'
          + '<div class="chq-bottom">'
            + '<span class="chq-client">' + c.client + '</span>'
            + (showWeek ? '<span class="tag tag-week">' + c.week + '</span>' : '')
            + (showOffice ? '<span class="tag tag-office">' + c.office + '</span>' : '')
          + '</div>'
        + '</div>'
        + '<span class="chq-pay">$' + c.netPay.toFixed(2) + '</span>';
      row.addEventListener('click', () => toggleSelect(c.uid));
    }
    chequeList.appendChild(row);
  });

  renderSelectedBar();
  updateConfirmBtn();
}

// =============================================
// SELECTION
// =============================================
function toggleSelect(uid) {
  if (selected.has(uid)) selected.delete(uid); else selected.add(uid);
  renderResults();
}

selectAllBtn.addEventListener('click', () => {
  const uncollected = searchResults.filter(c => !c.hasSignature);
  const allSel = uncollected.every(c => selected.has(c.uid));
  uncollected.forEach(c => { if (allSel) selected.delete(c.uid); else selected.add(c.uid); });
  renderResults();
});

function getSelectedCheques() {
  const allUids = new Set(selected);
  return searchResults.filter(c => allUids.has(c.uid));
}

function renderSelectedBar() {
  const sel = getSelectedCheques();
  if (sel.length === 0) {
    selectedBar.classList.add('hidden');
    actionArea.classList.add('hidden');
    return;
  }
  selectedBar.classList.remove('hidden');
  actionArea.classList.remove('hidden');

  const total = sel.reduce((s, c) => s + c.netPay, 0);
  selectedTitle.innerHTML = '<span class="count-badge">' + sel.length + '</span> cheque' + (sel.length !== 1 ? 's' : '') + ' selected ‚Äî $' + total.toFixed(2) + ' total';

  selectedChips.innerHTML = '';
  sel.forEach(c => {
    const chip = document.createElement('span');
    chip.className = 'selected-chip';
    chip.innerHTML = '<span class="chip-chq">' + c.chqNo + '</span>'
      + '<span>' + c.lastName + ' ' + c.firstName + '</span>'
      + '<span class="chip-pay">$' + c.netPay.toFixed(2) + '</span>'
      + '<span class="chip-remove" data-uid="' + c.uid + '">‚úï</span>';
    selectedChips.appendChild(chip);
  });

  selectedChips.querySelectorAll('.chip-remove').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      selected.delete(btn.dataset.uid);
      renderResults();
    });
  });
  updateConfirmBtn();
}

// =============================================
// PHOTO CAPTURE
// =============================================
const cameraInput = $('cameraInput');
const uploadInput = $('uploadInput');
const webcamModal = $('webcamModal');
const webcamVideo = $('webcamVideo');
const webcamError = $('webcamError');
let webcamStream = null;

function isMobile() { return /iPhone|iPad|iPod|Android/i.test(navigator.userAgent); }

$('cameraBtn').addEventListener('click', () => {
  if (isMobile()) { cameraInput.click(); } else { openWebcam(); }
});
$('uploadBtn').addEventListener('click', () => uploadInput.click());

cameraInput.addEventListener('change', handlePhoto);
uploadInput.addEventListener('change', handlePhoto);

// Retake button
$('retakeBtn').addEventListener('click', () => {
  photoDataUrl = null;
  photoPreview.style.display = 'none';
  updateConfirmBtn();
});

function handlePhoto(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    photoDataUrl = ev.target.result;
    photoImg.src = photoDataUrl;
    photoPreview.style.display = 'block';
    updateConfirmBtn();
  };
  reader.readAsDataURL(file);
  e.target.value = '';
}

async function openWebcam() {
  webcamModal.classList.remove('hidden');
  webcamError.classList.add('hidden');
  try {
    webcamStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user', width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });
    webcamVideo.srcObject = webcamStream;
  } catch (err) {
    webcamError.textContent = 'Could not access camera: ' + err.message;
    webcamError.classList.remove('hidden');
  }
}

function closeWebcam() {
  if (webcamStream) { webcamStream.getTracks().forEach(t => t.stop()); webcamStream = null; }
  webcamVideo.srcObject = null;
  webcamModal.classList.add('hidden');
}

$('webcamCloseBtn').addEventListener('click', closeWebcam);
webcamModal.addEventListener('click', (e) => { if (e.target === webcamModal) closeWebcam(); });

$('webcamSnapBtn').addEventListener('click', () => {
  if (!webcamStream) return;
  const canvas = document.createElement('canvas');
  canvas.width = webcamVideo.videoWidth;
  canvas.height = webcamVideo.videoHeight;
  canvas.getContext('2d').drawImage(webcamVideo, 0, 0);
  photoDataUrl = canvas.toDataURL('image/jpeg', 0.85);
  photoImg.src = photoDataUrl;
  photoPreview.style.display = 'block';
  updateConfirmBtn();
  closeWebcam();
});

// =============================================
// CONFIRM PICKUP
// =============================================
function updateConfirmBtn() {
  const sel = getSelectedCheques();
  const hasCollector = collectorInput.value.trim().length > 0;
  const hasPhoto = !!photoDataUrl;
  confirmBtn.disabled = sel.length === 0 || !hasCollector || !hasPhoto;
}

collectorInput.addEventListener('input', updateConfirmBtn);

confirmBtn.addEventListener('click', async () => {
  const sel = getSelectedCheques();
  if (sel.length === 0) return;
  const collector = collectorInput.value.trim();
  if (!collector) { showToast('Enter collector name'); return; }
  if (!photoDataUrl) { showToast('Take a photo first'); return; }

  confirmBtn.disabled = true;
  confirmBtn.textContent = 'Processing...';
  confirmBtn.classList.add('processing');

  const now = new Date();
  const date = now.toLocaleDateString('en-CA');
  const time = now.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
  const timestamp = date + ' ' + time;
  const weekEnding = sel[0].week || 'Unknown';

  const stampedBase64 = await stampPhoto(photoDataUrl, collector, sel, timestamp);

  const chqNums = sel.map(c => c.chqNo).join('_');
  const collectorClean = collector.replace(/[^a-zA-Z0-9]/g, '_');
  const timeFile = time.replace(':', '-');
  const filename = weekEnding + '_' + collectorClean + '_' + chqNums + '_' + date + '_' + timeFile + '.jpg';

  const pickupData = {
    action: 'confirmPickup', collector, timestamp, weekEnding,
    photoFilename: filename,
    photoBase64: stampedBase64.split(',')[1],
    cheques: sel.map(c => ({
      uid: c.uid, sheetName: c.sheetName, rowIndex: c.rowIndex,
      sigCol: c.sigCol, chqNo: c.chqNo,
      name: c.lastName + ' ' + c.firstName,
      week: c.week, office: c.office
    }))
  };

  if (isOnline) {
    try {
      const res = await api(pickupData);
      if (res.results) {
        const failed = res.results.filter(r => r.error);
        if (failed.length > 0) showToast('‚ö†Ô∏è ' + failed.length + ' already collected');
        const succeeded = res.results.filter(r => r.ok);
        if (succeeded.length > 0) {
          playConfirmSound();
          showToast('‚úÖ ' + succeeded.length + ' cheque(s) confirmed');
        }
      }
      addToHistory(collector, timestamp, sel, false);
    } catch (err) {
      queueOffline(pickupData, collector, timestamp, sel);
      showToast('‚ö° Queued offline ‚Äî will sync later');
    }
  } else {
    queueOffline(pickupData, collector, timestamp, sel);
    showToast('‚ö° Queued offline ‚Äî will sync later');
  }

  // Reset
  selected.clear(); photoDataUrl = null;
  photoPreview.style.display = 'none';
  collectorInput.value = '';
  confirmBtn.disabled = true;
  confirmBtn.textContent = 'Confirm Pickup';
  confirmBtn.classList.remove('processing');
  searchInput.value = '';
  resultsSection.classList.add('hidden');
  selectedBar.classList.add('hidden');
  actionArea.classList.add('hidden');
  searchResults = [];
});

// =============================================
// PHOTO STAMPING
// =============================================
function stampPhoto(dataUrl, collector, cheques, timestamp) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = function() {
      const canvas = $('stampCanvas');
      const maxW = 1200;
      let w = img.width, h = img.height;
      if (w > maxW) { h = h * maxW / w; w = maxW; }
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, w, h);

      const pad = 14;
      const fs = Math.max(14, w * 0.025);
      const lh = fs * 1.5;
      const chqText = cheques.map(c => c.chqNo + ' ' + c.lastName + ' ' + c.firstName).join(' | ');
      const lines = ['Collected by: ' + collector, timestamp, chqText];
      const boxH = lines.length * lh + pad * 2;
      const sy = h - boxH;

      ctx.fillStyle = 'rgba(15,23,42,0.75)';
      ctx.fillRect(0, sy, w, boxH);
      ctx.fillStyle = '#fff';
      ctx.font = '600 ' + fs + 'px Outfit,sans-serif';
      lines.forEach((line, i) => {
        ctx.fillText(line, pad, sy + pad + (i + 1) * lh - 4);
      });
      resolve(canvas.toDataURL('image/jpeg', 0.85));
    };
    img.src = dataUrl;
  });
}

// =============================================
// SOUND
// =============================================
function playConfirmSound() {
  try {
    const ac = new (window.AudioContext || window.webkitAudioContext)();
    [523, 659, 784].forEach((f, i) => {
      const o = ac.createOscillator(), g = ac.createGain();
      o.type = 'sine'; o.frequency.value = f;
      g.gain.setValueAtTime(0.12, ac.currentTime + i * 0.1);
      g.gain.exponentialRampToValueAtTime(0.001, ac.currentTime + i * 0.1 + 0.25);
      o.connect(g); g.connect(ac.destination);
      o.start(ac.currentTime + i * 0.1);
      o.stop(ac.currentTime + i * 0.1 + 0.25);
    });
  } catch (e) {}
}

// =============================================
// HISTORY
// =============================================
function addToHistory(collector, timestamp, cheques, offline) {
  history.unshift({
    collector, timestamp, offline,
    cheques: cheques.map(c => ({ chqNo: c.chqNo, name: c.lastName + ' ' + c.firstName, week: c.week, office: c.office }))
  });
  saveSessionHistory();
  renderHistory();
}

function renderHistory() {
  if (history.length === 0) { historySection.classList.add('hidden'); return; }
  historySection.classList.remove('hidden');
  historyList.innerHTML = '';
  history.forEach(h => {
    const div = document.createElement('div');
    div.className = 'history-item';
    const tags = h.cheques.map(c => '<span>' + c.chqNo + '</span> ' + c.name).join(' ¬∑ ');
    div.innerHTML = '<div class="hi-top"><span class="hi-collector">' + h.collector + '</span><span class="hi-time">' + h.timestamp + '</span></div>'
      + '<div class="hi-cheques">' + tags + '</div>'
      + (h.offline ? '<div class="hi-offline">‚ö° Queued offline</div>' : '');
    historyList.appendChild(div);
  });
}

function saveSessionHistory() {
  try { localStorage.setItem('cheque_session_history', JSON.stringify(history)); } catch (e) {}
}

function loadSessionHistory() {
  try {
    const saved = localStorage.getItem('cheque_session_history');
    if (saved) { history = JSON.parse(saved); renderHistory(); }
  } catch (e) {}
}

// =============================================
// OFFLINE QUEUE
// =============================================
function queueOffline(pickupData, collector, timestamp, cheques) {
  offlineQueue.push(pickupData);
  saveOfflineQueue();
  addToHistory(collector, timestamp, cheques, true);
  updateOfflineBar();
}

function saveOfflineQueue() {
  try { localStorage.setItem('cheque_offline_queue', JSON.stringify(offlineQueue)); } catch (e) {}
}

function loadOfflineQueue() {
  try {
    const saved = localStorage.getItem('cheque_offline_queue');
    if (saved) offlineQueue = JSON.parse(saved);
    updateOfflineBar();
  } catch (e) {}
}

async function syncOfflineQueue() {
  if (!isOnline || offlineQueue.length === 0) return;
  updateOfflineBar();
  const queue = [...offlineQueue];
  let synced = 0;
  for (let i = 0; i < queue.length; i++) {
    try {
      await api(queue[i]);
      offlineQueue.shift();
      saveOfflineQueue();
      synced++;
      updateOfflineBar();
    } catch (err) { break; }
  }
  if (synced > 0) {
    showToast('‚úÖ Synced ' + synced + ' offline pickup(s)');
    history.forEach(h => { if (h.offline) h.offline = false; });
    saveSessionHistory();
    renderHistory();
  }
  updateOfflineBar();
}

setInterval(() => { if (isOnline && offlineQueue.length > 0) syncOfflineQueue(); }, 30000);

// =============================================
// ADMIN UPLOAD
// =============================================
const adminModal = $('adminModal');
const uploadZone = $('uploadZone');
const payrollFileInput = $('payrollFileInput');
const uploadPreview = $('uploadPreview');
const modalUploadBtn = $('modalUploadBtn');
const uploadProgress = $('uploadProgress');
const uploadErrorDiv = $('uploadError');
const uploadSuccessDiv = $('uploadSuccess');
let parsedPayroll = null;

$('adminBtn').addEventListener('click', () => { adminModal.classList.remove('hidden'); resetUploadModal(); });
$('modalCloseBtn').addEventListener('click', () => { adminModal.classList.add('hidden'); });
adminModal.addEventListener('click', (e) => { if (e.target === adminModal) adminModal.classList.add('hidden'); });
uploadZone.addEventListener('click', () => payrollFileInput.click());

payrollFileInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  parsePayrollFile(file);
  e.target.value = '';
});

function resetUploadModal() {
  parsedPayroll = null;
  uploadPreview.classList.add('hidden');
  modalUploadBtn.classList.add('hidden');
  uploadProgress.classList.add('hidden');
  uploadErrorDiv.classList.add('hidden');
  uploadSuccessDiv.classList.add('hidden');
  uploadZone.classList.remove('hidden');
}

function parsePayrollFile(file) {
  if (typeof XLSX === 'undefined') {
    uploadErrorDiv.textContent = 'Excel library still loading ‚Äî wait a moment and try again';
    uploadErrorDiv.classList.remove('hidden');
    return;
  }
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const data = new Uint8Array(e.target.result);
      const wb = XLSX.read(data, { type: 'array' });
      let weekEnding = '';
      const fm = file.name.match(/WE\d{4}/i);
      if (fm) weekEnding = fm[0].toUpperCase();

      const sheets = [];
      let totalCheques = 0;

      wb.SheetNames.forEach(sheetName => {
        const ws = wb.Sheets[sheetName];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
        if (!weekEnding) {
          for (let r = 0; r < Math.min(rows.length, 5); r++) {
            if (!rows[r]) continue;
            for (let c = 0; c < rows[r].length; c++) {
              const v = String(rows[r][c] || '').trim();
              const m = v.match(/^WE\d{4}$/i);
              if (m) { weekEnding = v.toUpperCase(); break; }
            }
            if (weekEnding) break;
          }
        }
        let chqCount = 0;
        rows.forEach(row => {
          if (row) { for (let c = 0; c < row.length; c++) { if (String(row[c] || '').trim().toUpperCase() === 'CHQ') { chqCount++; break; } } }
        });
        totalCheques += chqCount;
        const cleanRows = rows.map(row => row.map(cell => {
          if (cell === null || cell === undefined) return '';
          if (cell instanceof Date) return cell.toISOString().split('T')[0];
          if (typeof cell === 'object') return String(cell);
          return cell;
        }));
        sheets.push({ name: sheetName, rows: cleanRows });
      });

      if (!weekEnding) {
        weekEnding = prompt('Could not detect week ending. Enter it (e.g. WE0214):') || '';
        weekEnding = weekEnding.toUpperCase().trim();
        if (!weekEnding) { uploadErrorDiv.textContent = 'Week ending is required'; uploadErrorDiv.classList.remove('hidden'); return; }
      }

      parsedPayroll = { weekEnding, sheets, fileName: file.name };
      uploadZone.classList.add('hidden');
      uploadPreview.classList.remove('hidden');
      modalUploadBtn.classList.remove('hidden');
      modalUploadBtn.disabled = false;
      $('upWeek').textContent = weekEnding;
      $('upOffices').textContent = sheets.map(s => s.name).join(', ');
      $('upCount').textContent = sheets.length + ' office tab' + (sheets.length !== 1 ? 's' : '') + ' ¬∑ ~' + totalCheques + ' cheques';
    } catch (err) {
      uploadErrorDiv.textContent = 'Error reading file: ' + err.message;
      uploadErrorDiv.classList.remove('hidden');
    }
  };
  reader.readAsArrayBuffer(file);
}

modalUploadBtn.addEventListener('click', async () => {
  if (!parsedPayroll) return;
  modalUploadBtn.disabled = true;
  uploadProgress.classList.remove('hidden');
  uploadProgress.textContent = 'Uploading ' + parsedPayroll.sheets.length + ' office tab(s)...';
  uploadErrorDiv.classList.add('hidden');
  try {
    const res = await api({ action: 'uploadPayroll', weekEnding: parsedPayroll.weekEnding, sheets: parsedPayroll.sheets });
    uploadProgress.classList.add('hidden');
    if (res.error) {
      uploadErrorDiv.textContent = res.error;
      uploadErrorDiv.classList.remove('hidden');
      modalUploadBtn.disabled = false;
    } else {
      uploadSuccessDiv.textContent = '‚úÖ ' + res.message;
      uploadSuccessDiv.classList.remove('hidden');
      modalUploadBtn.classList.add('hidden');
      await loadWeeks();
      showToast('‚úÖ ' + parsedPayroll.weekEnding + ' uploaded');
    }
  } catch (err) {
    uploadProgress.classList.add('hidden');
    uploadErrorDiv.textContent = 'Upload failed: ' + err.message;
    uploadErrorDiv.classList.remove('hidden');
    modalUploadBtn.disabled = false;
  }
});

// =============================================
// TOAST
// =============================================
function showToast(msg) {
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 3000);
}

// =============================================
// SHEETJS LOADER
// =============================================
(function loadSheetJS() {
  const CACHE_KEY = 'xlsx_lib_0185';
  const CDN_URL = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
  function exec(code) {
    try { const s = document.createElement('script'); s.textContent = code; document.body.appendChild(s); } catch (e) {}
  }
  const cached = localStorage.getItem(CACHE_KEY);
  if (cached) {
    exec(cached);
    if (navigator.onLine) { fetch(CDN_URL).then(r => r.text()).then(t => { try { localStorage.setItem(CACHE_KEY, t); } catch (e) {} }).catch(() => {}); }
  } else if (navigator.onLine) {
    fetch(CDN_URL).then(r => r.text()).then(t => { try { localStorage.setItem(CACHE_KEY, t); } catch (e) {} exec(t); }).catch(() => {});
  }
})();
</script>
</body>
</html>
